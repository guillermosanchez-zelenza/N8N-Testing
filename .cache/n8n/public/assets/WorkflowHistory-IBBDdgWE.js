import{G as B,r as g,e as $,b as ae,ag as S,l as W,m as L,H as J,p as d,R as v,T as H,O as V,S as N,M as U,u as T,Q as M,I as f,a2 as re,F as ie,a7 as le,aI as ce,aJ as we,D as de,w as ue,af as me}from"./vendor-NNwioulI.js";import{dw as fe,x as K,_ as D,aB as G,m as Q,l as pe,v as X,fO as ve,e as ke,u as ye,V as P,fU as _e,dK as he}from"./n8n-_nNvRoCf.js";import{aw as be}from"./index-xP-VuMjv.js";import{d as ge}from"./pinia-aUqqC48i.js";import{F as We}from"./file-saver-GLtlGJrO.js";import"./lodash-es-5z_C16pm.js";import"./axios-s2RMMPhA.js";import"./flatted-jPn12Tq4.js";import"./esprima-next-ulPLCZ1Z.js";import"./luxon-ZRIU05qF.js";import"./@vueuse/core-8g26_cc0.js";import"./uuid-McvpxQtQ.js";import"./vue-i18n-1PEMRmUU.js";import"./@n8n/permissions-8yMqUF1Y.js";import"./@n8n/codemirror-lang-sql-feLn5IS9.js";import"./@lezer/common-1hBQ1gIF.js";import"./codemirror-lang-html-n8n-wWQLhhqk.js";import"./prettier-s3fE3Qyr.js";import"./@jsplumb/util-DR0SB56A.js";import"./@jsplumb/core-MKwKlGip.js";import"./@jsplumb/common-Q5_tv_GT.js";import"./@jsplumb/connector-bezier-3dWY17R5.js";import"./@jsplumb/browser-ui-AlqFM-P6.js";import"./codemirror-lang-n8n-expression-HpIZnV_9.js";import"./fast-json-stable-stringify-eHEaCv8s.js";import"./timeago.js--Bumj2r9.js";import"./qrcode.vue-UdCmS1Sj.js";import"./vue3-touch-events-_RfbPMOD.js";import"./chart.js-JtqvIvkt.js";const Ie=["datetime"],$e=["value"],Te=B({__name:"WorkflowHistoryListItem",props:{item:{},index:{},actions:{},isActive:{type:Boolean}},emits:["action","preview","mounted"],setup(_,{emit:u}){const e=_,o=K(),k=g(!1),c=g(null),m=g(null),i=g(!1),p=$(()=>{const t=new Date().getFullYear().toString(),[a,r]=fe(e.item.createdAt,`${e.item.createdAt.startsWith(t)?"":"yyyy "}mmm d"#"HH:MM:ss`).split("#");return o.baseText("workflowHistory.item.createdAt",{interpolate:{date:a,time:r}})}),I=$(()=>{const t=e.item.authors.split(", ");let a=t[0];return t.length>1&&(a=`${a} + ${t.length-1}`),{size:t.length,label:a}}),x=$(()=>o.baseText("workflowHistory.item.id",{interpolate:{id:e.item.versionId}})),C=t=>{u("action",{action:t,id:e.item.versionId,data:{formattedCreatedAt:p.value}})},n=t=>{k.value=t},l=t=>{u("preview",{event:t,id:e.item.versionId})};return ae(()=>{var t,a,r;u("mounted",{index:e.index,offsetTop:((t=c.value)==null?void 0:t.offsetTop)??0,isActive:e.isActive}),i.value=((a=m.value)==null?void 0:a.scrollWidth)>((r=m.value)==null?void 0:r.clientWidth)}),(t,a)=>{const r=S("n8n-tooltip"),h=S("n8n-badge"),b=S("n8n-action-toggle");return W(),L("li",{ref_key:"itemElement",ref:c,"data-test-id":"workflow-history-list-item",class:f({[t.$style.item]:!0,[t.$style.active]:e.isActive,[t.$style.actionsVisible]:k.value})},[J(t.$slots,"default",{formattedCreatedAt:p.value},()=>[d("p",{onClick:l},[d("time",{datetime:t.item.createdAt},v(p.value),9,Ie),H(r,{placement:"right-end",disabled:I.value.size<2&&!i.value},{content:V(()=>[N(v(e.item.authors),1)]),default:V(()=>[d("span",{ref_key:"authorElement",ref:m},v(I.value.label),513)]),_:1},8,["disabled"]),d("data",{value:t.item.versionId},v(x.value),9,$e)])]),d("div",{class:f(t.$style.tail)},[e.index===0?(W(),U(h,{key:0},{default:V(()=>[N(v(T(o).baseText("workflowHistory.item.latest")),1)]),_:1})):M("",!0),H(b,{theme:"dark",class:f(t.$style.actions),actions:e.actions,placement:"bottom-end",onAction:C,onClick:a[0]||(a[0]=re(()=>{},["stop"])),onVisibleChange:n},{default:V(()=>[J(t.$slots,"action-toggle-button")]),_:3},8,["class","actions"])],2)],2)}}}),He="_item_1bawd_5",xe="_tail_1bawd_37",Ve="_active_1bawd_42",Ce="_actionsVisible_1bawd_49",Oe="_actions_1bawd_49",Se={item:He,tail:xe,active:Ve,actionsVisible:Ce,actions:Oe},Ae={$style:Se},Z=D(Te,[["__cssModules",Ae]]),Re=d("br",null,null,-1),Le=["aria-label"],Me=B({__name:"WorkflowHistoryList",props:{items:{},activeItem:{},actions:{},requestNumberOfItems:{},lastReceivedItemsLength:{},evaluatedPruneTime:{},shouldUpgrade:{type:Boolean},isListLoading:{type:Boolean}},emits:["action","preview","loadMore","upgrade"],setup(_,{emit:u}){const e=_,o=K(),k=g(null),c=g(!0),m=g(null),i=n=>n===0?e.actions.filter(l=>l.value!=="restore"):e.actions,p=n=>{m.value=new IntersectionObserver(([l])=>{var t,a;l.isIntersecting&&((t=m.value)==null||t.unobserve(n),(a=m.value)==null||a.disconnect(),m.value=null,u("loadMore",{take:e.requestNumberOfItems,skip:e.items.length}))},{root:k.value,threshold:.01}),m.value.observe(n)},I=({action:n,id:l,data:t})=>{c.value=!1,u("action",{action:n,id:l,data:t})},x=({event:n,id:l})=>{c.value=!1,u("preview",{event:n,id:l})},C=({index:n,offsetTop:l,isActive:t})=>{var a,r;t&&c.value&&(c.value=!1,(a=k.value)==null||a.scrollTo({top:l,behavior:"smooth"})),n===e.items.length-1&&e.lastReceivedItemsLength===e.requestNumberOfItems&&p((r=k.value)==null?void 0:r.children[n])};return(n,l)=>{const t=S("n8n-loading"),a=S("i18n-t");return W(),L("ul",{ref_key:"listElement",ref:k,class:f(n.$style.list),"data-test-id":"workflow-history-list"},[(W(!0),L(ie,null,le(e.items,(r,h)=>{var b;return W(),U(Z,{key:r.versionId,index:h,item:r,"is-active":r.versionId===((b=e.activeItem)==null?void 0:b.versionId),actions:i(h),onAction:I,onPreview:x,onMounted:C},null,8,["index","item","is-active","actions"])}),128)),!e.items.length&&!e.isListLoading?(W(),L("li",{key:0,class:f(n.$style.empty)},[N(v(T(o).baseText("workflowHistory.empty"))+" ",1),Re,N(" "+v(T(o).baseText("workflowHistory.hint")),1)],2)):M("",!0),e.isListLoading?(W(),L("li",{key:1,class:f(n.$style.loader),role:"status","aria-live":"polite","aria-busy":"true","aria-label":T(o).baseText("generic.loading")},[H(t,{rows:3,class:"mb-xs"}),H(t,{rows:3,class:"mb-xs"}),H(t,{rows:3,class:"mb-xs"})],10,Le)):M("",!0),e.shouldUpgrade?(W(),L("li",{key:2,class:f(n.$style.retention)},[d("span",null,v(T(o).baseText("workflowHistory.limit",{interpolate:{evaluatedPruneTime:e.evaluatedPruneTime}})),1),H(a,{keypath:"workflowHistory.upgrade",tag:"span"},{link:V(()=>[d("a",{href:"#",onClick:l[0]||(l[0]=r=>u("upgrade"))},v(T(o).baseText("workflowHistory.upgrade.link")),1)]),_:1})],2)):M("",!0)],2)}}}),Ee="_list_1h1nd_5",Ne="_empty_1h1nd_14",Ue="_loader_1h1nd_27",Pe="_retention_1h1nd_31",Fe={list:Ee,empty:Ne,loader:Ue,retention:Pe},Be={$style:Fe},Ke=D(Me,[["__cssModules",Be]]),De=["datetime"],ze=["value"],qe=B({__name:"WorkflowHistoryContent",props:{workflow:{},workflowVersion:{},actions:{},isListLoading:{type:Boolean},isFirstItemShown:{type:Boolean}},emits:["action"],setup(_,{emit:u}){const e=_,o=K(),k=$(()=>{if(!e.workflowVersion||!e.workflow)return;const{pinData:i,...p}=e.workflow;return{...p,nodes:e.workflowVersion.nodes,connections:e.workflowVersion.connections}}),c=$(()=>e.isFirstItemShown?e.actions.filter(i=>i.value!=="restore"):e.actions),m=({action:i,id:p,data:I})=>{u("action",{action:i,id:p,data:I})};return(i,p)=>{const I=S("n8n-icon"),x=S("n8n-button");return W(),L("div",{class:f(i.$style.content)},[e.workflowVersion?(W(),U(be,{key:0,workflow:k.value,loading:e.isListLoading,"loader-type":"spinner"},null,8,["workflow","loading"])):M("",!0),d("ul",{class:f(i.$style.info)},[e.workflowVersion?(W(),U(Z,{key:0,class:f(i.$style.card),index:-1,item:e.workflowVersion,"is-active":!1,actions:c.value,onAction:m},{default:V(({formattedCreatedAt:C})=>[d("section",{class:f(i.$style.text)},[d("p",null,[d("span",{class:f(i.$style.label)},v(T(o).baseText("workflowHistory.content.title"))+": ",3),d("time",{datetime:e.workflowVersion.createdAt},v(C),9,De)]),d("p",null,[d("span",{class:f(i.$style.label)},v(T(o).baseText("workflowHistory.content.editedBy"))+": ",3),d("span",null,v(e.workflowVersion.authors),1)]),d("p",null,[d("span",{class:f(i.$style.label)},v(T(o).baseText("workflowHistory.content.versionId"))+": ",3),d("data",{value:e.workflowVersion.versionId},v(e.workflowVersion.versionId),9,ze)])],2)]),"action-toggle-button":V(()=>[H(x,{type:"tertiary",size:"large","data-test-id":"action-toggle-button"},{default:V(()=>[N(v(T(o).baseText("workflowHistory.content.actions"))+" ",1),H(I,{class:"ml-3xs",icon:"chevron-down",size:"small"})]),_:1})]),_:1},8,["class","item","actions"])):M("",!0)],2)],2)}}}),Ye="_content_1xe4n_5",je="_info_1xe4n_15",Je="_card_1xe4n_23",Ge="_text_1xe4n_28",Qe="_label_1xe4n_53",Xe={content:Ye,info:je,card:Je,text:Ge,label:Qe},Ze={$style:Xe},et=D(qe,[["__cssModules",Ze]]),tt=async(_,u,e)=>{const{data:o}=await G(_.baseUrl,`/workflow-history/workflow/${u}`,e);return o},ot=async(_,u,e)=>{const{data:o}=await G(_.baseUrl,`/workflow-history/workflow/${u}/version/${e}`);return o},st=ge("workflowHistory",()=>{const _=Q(),u=pe(),e=X(),o=$(()=>u.settings.workflowHistory.licensePruneTime),k=$(()=>u.settings.workflowHistory.pruneTime),c=$(()=>Math.min(k.value,o.value)),m=$(()=>o.value!==-1&&o.value===k.value),i=async(n,l)=>await tt(_.getRestApiContext,n,l),p=async(n,l)=>await ot(_.getRestApiContext,n,l);return{getWorkflowHistory:i,getWorkflowVersion:p,downloadVersion:async(n,l,t)=>{const[a,r]=await Promise.all([e.fetchWorkflow(n),p(n,l)]),{connections:h,nodes:b}=r,A=new Blob([JSON.stringify({...a,nodes:b,connections:h},null,2)],{type:"application/json;charset=utf-8"});We.saveAs(A,`${a.name}(${t.formattedCreatedAt}).json`)},cloneIntoNewWorkflow:async(n,l,t)=>{const[a,r]=await Promise.all([e.fetchWorkflow(n),p(n,l)]),{connections:h,nodes:b}=r,{name:A}=a,z=await ve(_.getRestApiContext,`${A} (${t.formattedCreatedAt})`),R={nodes:b,connections:h,name:z.name};return await e.createNewWorkflow(R)},restoreWorkflow:async(n,l,t)=>{const a=await p(n,l),{connections:r,nodes:h}=a,b={connections:r,nodes:h};return t&&(b.active=!1),await e.updateWorkflow(n,b,!0).catch(async A=>{if(A.httpStatusCode===400&&A.message.includes("can not be activated"))return await e.fetchWorkflow(n);throw new Error(A)})},evaluatedPruneTime:c,shouldUpgrade:m}}),nt=B({__name:"WorkflowHistory",setup(_){const u=["restore","clone","open","download"],e=u.reduce((s,w)=>({...s,[w.toUpperCase()]:w}),{}),o=ce(),k=we(),c=K(),m=ke(),i=st(),p=ye(),I=X(),x=g(!0),C=g(!0),n=g(20),l=g(0),t=$(()=>({name:P.WORKFLOW,params:{name:o.params.workflowId}})),a=g(null),r=g([]),h=g(null),b=$(()=>u.map(s=>({label:c.baseText(`workflowHistory.item.actions.${s}`),disabled:!1,value:s}))),A=$(()=>{var s;return((s=r.value[0])==null?void 0:s.versionId)===o.params.versionId}),z=$(()=>Math.floor(i.evaluatedPruneTime/24)),R=s=>{_e.track(s,{instance_id:Q().instanceId,workflow_id:o.params.workflowId})},q=async s=>{const w=await i.getWorkflowHistory(o.params.workflowId,s);l.value=w.length,r.value=r.value.concat(w)};de(async()=>{R("User opened workflow history");try{const[s]=await Promise.all([I.fetchWorkflow(o.params.workflowId),q({take:n.value})]);a.value=s,C.value=!1,!o.params.versionId&&r.value.length&&await k.replace({name:P.WORKFLOW_HISTORY,params:{workflowId:o.params.workflowId,versionId:r.value[0].versionId}})}catch(s){x.value=!1,m.showError(s,c.baseText("workflowHistory.title"))}});const Y=s=>{const{href:w}=k.resolve({name:P.WORKFLOW_HISTORY,params:{workflowId:o.params.workflowId,versionId:s}});window.open(w,"_blank")},ee=async(s,w)=>await new Promise((y,O)=>{const E=[{text:c.baseText("workflowHistory.action.restore.modal.button.cancel"),type:"tertiary",action:()=>{y("cancel")}}];s&&E.push({text:c.baseText("workflowHistory.action.restore.modal.button.deactivateAndRestore"),type:"tertiary",action:()=>{y("deactivateAndRestore")}}),E.push({text:c.baseText("workflowHistory.action.restore.modal.button.restore"),type:"primary",action:()=>{y("restore")}});try{p.openModalWithData({name:he,data:{beforeClose:()=>{y("cancel")},isWorkflowActivated:s,formattedCreatedAt:w,buttons:E}})}catch(F){O(F)}}),te=async(s,w)=>{const y=await i.cloneIntoNewWorkflow(o.params.workflowId,s,w),{href:O}=k.resolve({name:P.WORKFLOW,params:{name:y.id}});m.showMessage({title:c.baseText("workflowHistory.action.clone.success.title"),message:me("a",{href:O,target:"_blank"},c.baseText("workflowHistory.action.clone.success.message")),type:"success",duration:1e4})},oe=async(s,w)=>{const y=await I.fetchWorkflow(o.params.workflowId),O=await ee(y.active,w.formattedCreatedAt);if(O==="cancel")return;a.value=await i.restoreWorkflow(o.params.workflowId,s,O==="deactivateAndRestore");const E=await i.getWorkflowHistory(o.params.workflowId,{take:1});r.value=E.concat(r.value),m.showMessage({title:c.baseText("workflowHistory.action.restore.success.title"),type:"success"})},j=async({action:s,id:w,data:y})=>{try{switch(s){case e.OPEN:Y(w),R("User opened version in new tab");break;case e.DOWNLOAD:await i.downloadVersion(o.params.workflowId,w,y),R("User downloaded version");break;case e.CLONE:await te(w,y),R("User cloned version");break;case e.RESTORE:await oe(w,y),R("User restored version");break}}catch(O){m.showError(O,c.baseText("workflowHistory.action.error.title",{interpolate:{action:c.baseText(`workflowHistory.item.actions.${s}`).toLowerCase()}}))}},se=async({event:s,id:w})=>{s.metaKey||s.ctrlKey?(Y(w),R("User opened version in new tab")):await k.push({name:P.WORKFLOW_HISTORY,params:{workflowId:o.params.workflowId,versionId:w}})},ne=()=>{p.goToUpgrade("workflow-history","upgrade-workflow-history")};return ue(async()=>{if(o.params.versionId){try{h.value=await i.getWorkflowVersion(o.params.workflowId,o.params.versionId),R("User selected version")}catch(s){m.showError(new Error(`${s.message} "${o.params.versionId}"&nbsp;`),c.baseText("workflowHistory.title"))}try{a.value=await I.fetchWorkflow(o.params.workflowId)}catch(s){x.value=!1,m.showError(s,c.baseText("workflowHistory.title"))}}}),(s,w)=>{const y=S("n8n-heading"),O=S("n8n-button"),E=S("router-link");return W(),L("div",{class:f(s.$style.view)},[H(y,{class:f(s.$style.header),tag:"h2",size:"medium"},{default:V(()=>{var F;return[N(v((F=a.value)==null?void 0:F.name),1)]}),_:1},8,["class"]),d("div",{class:f(s.$style.corner)},[H(y,{tag:"h2",size:"medium",bold:""},{default:V(()=>[N(v(T(c).baseText("workflowHistory.title")),1)]),_:1}),H(E,{to:t.value,"data-test-id":"workflow-history-close-button"},{default:V(()=>[H(O,{type:"tertiary",icon:"times",size:"small",text:"",square:""})]),_:1},8,["to"])],2),d("div",{class:f(s.$style.listComponentWrapper)},[x.value?(W(),U(Ke,{key:0,items:r.value,"last-received-items-length":l.value,"active-item":h.value,actions:b.value,"request-number-of-items":n.value,"should-upgrade":T(i).shouldUpgrade,"evaluated-prune-time":z.value,"is-list-loading":C.value,onAction:j,onPreview:se,onLoadMore:q,onUpgrade:ne},null,8,["items","last-received-items-length","active-item","actions","request-number-of-items","should-upgrade","evaluated-prune-time","is-list-loading"])):M("",!0)],2),d("div",{class:f(s.$style.contentComponentWrapper)},[x.value?(W(),U(et,{key:0,workflow:a.value,"workflow-version":h.value,actions:b.value,"is-list-loading":C.value,"is-first-item-shown":A.value,onAction:j},null,8,["workflow","workflow-version","actions","is-list-loading","is-first-item-shown"])):M("",!0)],2)],2)}}}),at="_view_1ax7n_5",rt="_header_1ax7n_15",it="_corner_1ax7n_23",lt="_contentComponentWrapper_1ax7n_34",ct="_listComponentWrapper_1ax7n_39",wt={view:at,header:rt,corner:it,contentComponentWrapper:lt,listComponentWrapper:ct},dt={$style:wt},Ft=D(nt,[["__cssModules",dt]]);export{Ft as default};
//# sourceMappingURL=WorkflowHistory-IBBDdgWE.js.map

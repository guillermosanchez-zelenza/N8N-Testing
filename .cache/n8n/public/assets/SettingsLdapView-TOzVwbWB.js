import{fA as z,fB as E,e as D,k as A,u as w,l as L,f as I,fC as y,fD as k,a6 as V,_ as F}from"./n8n-_nNvRoCf.js";import{a as M}from"./index-xP-VuMjv.js";import{h as _}from"./humanize-duration-sKbswfzh.js";import{K as N}from"./v3-infinite-loading-A5V-QVvg.js";import{m as R}from"./pinia-aUqqC48i.js";import{G as U,ag as o,aq as q,l as r,m as g,p as l,T as s,O as n,S as u,R as d,I as p,M as m,Q as f,V as B}from"./vendor-NNwioulI.js";import"./lodash-es-5z_C16pm.js";import"./axios-s2RMMPhA.js";import"./flatted-jPn12Tq4.js";import"./esprima-next-ulPLCZ1Z.js";import"./luxon-ZRIU05qF.js";import"./@vueuse/core-8g26_cc0.js";import"./uuid-McvpxQtQ.js";import"./vue-i18n-1PEMRmUU.js";import"./@n8n/permissions-8yMqUF1Y.js";import"./@n8n/codemirror-lang-sql-feLn5IS9.js";import"./@lezer/common-1hBQ1gIF.js";import"./codemirror-lang-html-n8n-wWQLhhqk.js";import"./prettier-s3fE3Qyr.js";import"./@jsplumb/util-DR0SB56A.js";import"./@jsplumb/core-MKwKlGip.js";import"./@jsplumb/common-Q5_tv_GT.js";import"./@jsplumb/connector-bezier-3dWY17R5.js";import"./@jsplumb/browser-ui-AlqFM-P6.js";import"./codemirror-lang-n8n-expression-HpIZnV_9.js";import"./fast-json-stable-stringify-eHEaCv8s.js";import"./timeago.js--Bumj2r9.js";import"./qrcode.vue-UdCmS1Sj.js";import"./vue3-touch-events-_RfbPMOD.js";import"./chart.js-JtqvIvkt.js";const P=U({name:"SettingsLdapView",components:{InfiniteLoading:N,ElTable:z,ElTableColumn:E},setup(){return{...D(),...M()}},data(){return{dataTable:[],tableKey:0,adConfig:{},loadingTestConnection:!1,loadingDryRun:!1,loadingLiveRun:!1,loadingTable:!1,hasAnyChanges:!1,formInputs:null,formBus:A(),readyToSubmit:!1,page:0,loginEnabled:!1,syncEnabled:!1}},async mounted(){this.isLDAPFeatureEnabled&&await this.getLdapConfig()},computed:{...R(I,L,w),currentUser(){return this.usersStore.currentUser},isLDAPFeatureEnabled(){return this.settingsStore.settings.enterprise.ldap}},methods:{goToUpgrade(){this.uiStore.goToUpgrade("ldap","upgrade-ldap")},cellClassStyle({row:e,column:t}){if(t.property==="status"){if(e.status==="Success")return{color:"green"};if(e.status==="Error")return{color:"red"}}if(t.property==="runMode"){if(e.runMode==="Dry")return{color:"orange"};if(e.runMode==="Live")return{color:"blue"}}return{}},onInput(e){e.name==="loginEnabled"&&typeof e.value=="boolean"&&(this.loginEnabled=e.value),e.name==="synchronizationEnabled"&&typeof e.value=="boolean"&&(this.syncEnabled=e.value),this.hasAnyChanges=!0},onReadyToSubmit(e){this.readyToSubmit=e},syncDataMapper(e){const t=new Date(e.startedAt),i=new Date(e.endedAt),a=i.getTime()-t.getTime();return{runTime:_(a),runMode:y(e.runMode),status:y(e.status),endedAt:k(i.getTime()),details:this.$locale.baseText("settings.ldap.usersScanned",{interpolate:{scanned:e.scanned.toString()}})}},async onSubmit(){const e=this.$refs.ldapConfigForm;if(!this.hasAnyChanges||!e)return;const t={loginEnabled:e.values.loginEnabled,loginLabel:e.values.loginLabel,connectionUrl:e.values.serverAddress,allowUnauthorizedCerts:e.values.allowUnauthorizedCerts,connectionPort:+e.values.port,connectionSecurity:e.values.connectionSecurity,baseDn:e.values.baseDn,bindingAdminDn:e.values.bindingType==="admin"?e.values.adminDn:"",bindingAdminPassword:e.values.bindingType==="admin"?e.values.adminPassword:"",emailAttribute:e.values.email,firstNameAttribute:e.values.firstName,lastNameAttribute:e.values.lastName,loginIdAttribute:e.values.loginId,ldapIdAttribute:e.values.ldapId,userFilter:e.values.userFilter,synchronizationEnabled:e.values.synchronizationEnabled,synchronizationInterval:+e.values.synchronizationInterval,searchPageSize:+e.values.pageSize,searchTimeout:+e.values.searchTimeout};let i=!0;try{this.adConfig.loginEnabled&&!t.loginEnabled&&(i=await this.confirm(this.$locale.baseText("settings.ldap.confirmMessage.beforeSaveForm.message"),this.$locale.baseText("settings.ldap.confirmMessage.beforeSaveForm.headline"),{cancelButtonText:this.$locale.baseText("settings.ldap.confirmMessage.beforeSaveForm.cancelButtonText"),confirmButtonText:this.$locale.baseText("settings.ldap.confirmMessage.beforeSaveForm.confirmButtonText")})===V),i||(this.hasAnyChanges=!0),this.adConfig=await this.settingsStore.updateLdapConfig(t),this.showToast({title:this.$locale.baseText("settings.ldap.updateConfiguration"),message:"",type:"success"})}catch(a){this.showError(a,this.$locale.baseText("settings.ldap.configurationError"))}finally{i&&(this.hasAnyChanges=!1)}},onSaveClick(){this.formBus.emit("submit")},async onTestConnectionClick(){this.loadingTestConnection=!0;try{await this.settingsStore.testLdapConnection(),this.showToast({title:this.$locale.baseText("settings.ldap.connectionTest"),message:this.$locale.baseText("settings.ldap.toast.connection.success"),type:"success"})}catch(e){this.showToast({title:this.$locale.baseText("settings.ldap.connectionTestError"),message:e.message,type:"error"})}finally{this.loadingTestConnection=!1}},async onDryRunClick(){this.loadingDryRun=!0;try{await this.settingsStore.runLdapSync({type:"dry"}),this.showToast({title:this.$locale.baseText("settings.ldap.runSync.title"),message:this.$locale.baseText("settings.ldap.toast.sync.success"),type:"success"})}catch(e){this.showError(e,this.$locale.baseText("settings.ldap.synchronizationError"))}finally{this.loadingDryRun=!1,await this.reloadLdapSynchronizations()}},async onLiveRunClick(){this.loadingLiveRun=!0;try{await this.settingsStore.runLdapSync({type:"live"}),this.showToast({title:this.$locale.baseText("settings.ldap.runSync.title"),message:this.$locale.baseText("settings.ldap.toast.sync.success"),type:"success"})}catch(e){this.showError(e,this.$locale.baseText("settings.ldap.synchronizationError"))}finally{this.loadingLiveRun=!1,await this.reloadLdapSynchronizations()}},async getLdapConfig(){try{this.adConfig=await this.settingsStore.getLdapConfig(),this.loginEnabled=this.adConfig.loginEnabled,this.syncEnabled=this.adConfig.synchronizationEnabled;const e=a=>a.loginEnabled===!0,t=a=>a.synchronizationEnabled===!0&&a.loginEnabled===!0,i=a=>a.bindingType==="admin"&&a.loginEnabled===!0;this.formInputs=[{name:"loginEnabled",initialValue:this.adConfig.loginEnabled,properties:{type:"toggle",label:this.$locale.baseText("settings.ldap.form.loginEnabled.label"),tooltipText:this.$locale.baseText("settings.ldap.form.loginEnabled.tooltip"),required:!0}},{name:"loginLabel",initialValue:this.adConfig.loginLabel,properties:{label:this.$locale.baseText("settings.ldap.form.loginLabel.label"),required:!0,placeholder:this.$locale.baseText("settings.ldap.form.loginLabel.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.loginLabel.infoText")},shouldDisplay:e},{name:"serverAddress",initialValue:this.adConfig.connectionUrl,properties:{label:this.$locale.baseText("settings.ldap.form.serverAddress.label"),required:!0,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.serverAddress.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.serverAddress.infoText")},shouldDisplay:e},{name:"port",initialValue:this.adConfig.connectionPort,properties:{type:"number",label:this.$locale.baseText("settings.ldap.form.port.label"),capitalize:!0,infoText:this.$locale.baseText("settings.ldap.form.port.infoText")},shouldDisplay:e},{name:"connectionSecurity",initialValue:this.adConfig.connectionSecurity,properties:{type:"select",label:this.$locale.baseText("settings.ldap.form.connectionSecurity.label"),infoText:this.$locale.baseText("settings.ldap.form.connectionSecurity.infoText"),options:[{label:"None",value:"none"},{label:"TLS",value:"tls"},{label:"STARTTLS",value:"startTls"}],required:!0,capitalize:!0},shouldDisplay:e},{name:"allowUnauthorizedCerts",initialValue:this.adConfig.allowUnauthorizedCerts,properties:{type:"toggle",label:this.$locale.baseText("settings.ldap.form.allowUnauthorizedCerts.label"),required:!1},shouldDisplay(a){return a.connectionSecurity!=="none"&&a.loginEnabled===!0}},{name:"baseDn",initialValue:this.adConfig.baseDn,properties:{label:this.$locale.baseText("settings.ldap.form.baseDn.label"),required:!0,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.baseDn.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.baseDn.infoText")},shouldDisplay:e},{name:"bindingType",initialValue:"admin",properties:{type:"select",label:this.$locale.baseText("settings.ldap.form.bindingType.label"),infoText:this.$locale.baseText("settings.ldap.form.bindingType.infoText"),options:[{value:"admin",label:"Admin"},{value:"anonymous",label:"Anonymous"}]},shouldDisplay:e},{name:"adminDn",initialValue:this.adConfig.bindingAdminDn,properties:{label:this.$locale.baseText("settings.ldap.form.adminDn.label"),placeholder:this.$locale.baseText("settings.ldap.form.adminDn.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.adminDn.infoText"),capitalize:!0},shouldDisplay:i},{name:"adminPassword",initialValue:this.adConfig.bindingAdminPassword,properties:{label:this.$locale.baseText("settings.ldap.form.adminPassword.label"),type:"password",capitalize:!0,infoText:this.$locale.baseText("settings.ldap.form.adminPassword.infoText")},shouldDisplay:i},{name:"userFilter",initialValue:this.adConfig.userFilter,properties:{label:this.$locale.baseText("settings.ldap.form.userFilter.label"),type:"text",required:!1,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.userFilter.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.userFilter.infoText")},shouldDisplay:e},{name:"attributeMappingInfo",properties:{label:this.$locale.baseText("settings.ldap.form.attributeMappingInfo.label"),type:"info",labelSize:"large",labelAlignment:"left"},shouldDisplay:e},{name:"ldapId",initialValue:this.adConfig.ldapIdAttribute,properties:{label:this.$locale.baseText("settings.ldap.form.ldapId.label"),type:"text",required:!0,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.ldapId.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.ldapId.infoText")},shouldDisplay:e},{name:"loginId",initialValue:this.adConfig.loginIdAttribute,properties:{label:this.$locale.baseText("settings.ldap.form.loginId.label"),type:"text",autocomplete:"email",required:!0,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.loginId.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.loginId.infoText")},shouldDisplay:e},{name:"email",initialValue:this.adConfig.emailAttribute,properties:{label:this.$locale.baseText("settings.ldap.form.email.label"),type:"text",autocomplete:"email",required:!0,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.email.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.email.infoText")},shouldDisplay:e},{name:"firstName",initialValue:this.adConfig.firstNameAttribute,properties:{label:this.$locale.baseText("settings.ldap.form.firstName.label"),type:"text",autocomplete:"email",required:!0,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.firstName.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.firstName.infoText")},shouldDisplay:e},{name:"lastName",initialValue:this.adConfig.lastNameAttribute,properties:{label:this.$locale.baseText("settings.ldap.form.lastName.label"),type:"text",autocomplete:"email",required:!0,capitalize:!0,placeholder:this.$locale.baseText("settings.ldap.form.lastName.placeholder"),infoText:this.$locale.baseText("settings.ldap.form.lastName.infoText")},shouldDisplay:e},{name:"synchronizationEnabled",initialValue:this.adConfig.synchronizationEnabled,properties:{type:"toggle",label:this.$locale.baseText("settings.ldap.form.synchronizationEnabled.label"),tooltipText:this.$locale.baseText("settings.ldap.form.synchronizationEnabled.tooltip"),required:!0},shouldDisplay:e},{name:"synchronizationInterval",initialValue:this.adConfig.synchronizationInterval,properties:{type:"number",label:this.$locale.baseText("settings.ldap.form.synchronizationInterval.label"),infoText:this.$locale.baseText("settings.ldap.form.synchronizationInterval.infoText")},shouldDisplay:t},{name:"pageSize",initialValue:this.adConfig.searchPageSize,properties:{type:"number",label:this.$locale.baseText("settings.ldap.form.pageSize.label"),infoText:this.$locale.baseText("settings.ldap.form.pageSize.infoText")},shouldDisplay:t},{name:"searchTimeout",initialValue:this.adConfig.searchTimeout,properties:{type:"number",label:this.$locale.baseText("settings.ldap.form.searchTimeout.label"),infoText:this.$locale.baseText("settings.ldap.form.searchTimeout.infoText")},shouldDisplay:t}]}catch(e){this.showError(e,this.$locale.baseText("settings.ldap.configurationError"))}},async getLdapSynchronizations(e){try{this.loadingTable=!0;const t=await this.settingsStore.getLdapSynchronizations({page:this.page});t.length!==0?(this.dataTable.push(...t.map(this.syncDataMapper)),this.page+=1,e.loaded()):e.complete(),this.loadingTable=!1}catch(t){this.showError(t,this.$locale.baseText("settings.ldap.synchronizationError"))}},async reloadLdapSynchronizations(){try{this.page=0,this.tableKey+=1,this.dataTable=[]}catch(e){this.showError(e,this.$locale.baseText("settings.ldap.synchronizationError"))}}}}),H="_container_f18ao_5",K="_syncTable_f18ao_9",O="_header_f18ao_13",G="_enableFeatureContainer_f18ao_22",Q="_sectionHeader_f18ao_36",j="_settingsForm_f18ao_40",J="_docsInfoTip_f18ao_44",W={container:H,syncTable:K,header:O,enableFeatureContainer:G,sectionHeader:Q,settingsForm:j,docsInfoTip:J},X={key:0},Y={key:1},Z=["innerHTML"],ee={key:0},te={class:"pb-3xl"};function ae(e,t,i,a,ie,le){const h=o("n8n-heading"),T=o("n8n-info-tip"),$=o("n8n-action-box"),x=o("n8n-form-inputs"),b=o("n8n-button"),c=o("ElTableColumn"),C=o("InfiniteLoading"),v=o("ElTable"),S=q("loading");return e.isLDAPFeatureEnabled?(r(),g("div",Y,[l("div",{class:p(e.$style.container)},[l("div",{class:p(e.$style.header)},[s(h,{size:"2xlarge"},{default:n(()=>[u(d(e.$locale.baseText("settings.ldap")),1)]),_:1})],2),l("div",{class:p(e.$style.docsInfoTip)},[s(T,{theme:"info",type:"note"},{default:n(()=>[l("span",{innerHTML:e.$locale.baseText("settings.ldap.infoTip")},null,8,Z)]),_:1})],2),l("div",{class:p(e.$style.settingsForm)},[e.formInputs?(r(),m(x,{key:0,ref:"ldapConfigForm",inputs:e.formInputs,"event-bus":e.formBus,"column-view":!0,"vertical-spacing":"l",onUpdate:e.onInput,onReady:e.onReadyToSubmit,onSubmit:e.onSubmit},null,8,["inputs","event-bus","onUpdate","onReady","onSubmit"])):f("",!0)],2),l("div",null,[e.loginEnabled?(r(),m(b,{key:0,label:e.loadingTestConnection?e.$locale.baseText("settings.ldap.testingConnection"):e.$locale.baseText("settings.ldap.testConnection"),size:"large",class:"mr-s",disabled:e.hasAnyChanges||!e.readyToSubmit,loading:e.loadingTestConnection,onClick:e.onTestConnectionClick},null,8,["label","disabled","loading","onClick"])):f("",!0),s(b,{label:e.$locale.baseText("settings.ldap.save"),size:"large",disabled:!e.hasAnyChanges||!e.readyToSubmit,onClick:e.onSaveClick},null,8,["label","disabled","onClick"])])],2),e.loginEnabled?(r(),g("div",ee,[s(h,{tag:"h1",class:"mb-xl mt-3xl",size:"medium"},{default:n(()=>[u(d(e.$locale.baseText("settings.ldap.section.synchronization.title")),1)]),_:1}),l("div",{class:p(e.$style.syncTable)},[B((r(),m(v,{key:e.tableKey,border:!0,stripe:!0,data:e.dataTable,"cell-style":e.cellClassStyle,style:{width:"100%"},"max-height":"250"},{empty:n(()=>[u(d(e.$locale.baseText("settings.ldap.synchronizationTable.empty.message")),1)]),append:n(()=>[s(C,{target:".el-table__body-wrapper",onInfinite:e.getLdapSynchronizations},null,8,["onInfinite"])]),default:n(()=>[s(c,{prop:"status",label:e.$locale.baseText("settings.ldap.synchronizationTable.column.status")},null,8,["label"]),s(c,{prop:"endedAt",label:e.$locale.baseText("settings.ldap.synchronizationTable.column.endedAt")},null,8,["label"]),s(c,{prop:"runMode",label:e.$locale.baseText("settings.ldap.synchronizationTable.column.runMode")},null,8,["label"]),s(c,{prop:"runTime",label:e.$locale.baseText("settings.ldap.synchronizationTable.column.runTime")},null,8,["label"]),s(c,{prop:"details",label:e.$locale.baseText("settings.ldap.synchronizationTable.column.details")},null,8,["label"])]),_:1},8,["data","cell-style"])),[[S,e.loadingTable]])],2),l("div",te,[s(b,{label:e.$locale.baseText("settings.ldap.dryRun"),type:"secondary",size:"large",class:"mr-s",disabled:e.hasAnyChanges||!e.readyToSubmit,loading:e.loadingDryRun,onClick:e.onDryRunClick},null,8,["label","disabled","loading","onClick"]),s(b,{label:e.$locale.baseText("settings.ldap.synchronizeNow"),size:"large",disabled:e.hasAnyChanges||!e.readyToSubmit,loading:e.loadingLiveRun,onClick:e.onLiveRunClick},null,8,["label","disabled","loading","onClick"])])])):f("",!0)])):(r(),g("div",X,[l("div",{class:p([e.$style.header,"mb-2xl"])},[s(h,{size:"2xlarge"},{default:n(()=>[u(d(e.$locale.baseText("settings.ldap")),1)]),_:1})],2),s(T,{type:"note",theme:"info","tooltip-placement":"right",class:"mb-l"},{default:n(()=>[u(d(e.$locale.baseText("settings.ldap.note")),1)]),_:1}),s($,{description:e.$locale.baseText("settings.ldap.disabled.description"),"button-text":e.$locale.baseText("settings.ldap.disabled.buttonText"),"onClick:button":e.goToUpgrade},{heading:n(()=>[l("span",null,d(e.$locale.baseText("settings.ldap.disabled.title")),1)]),_:1},8,["description","button-text","onClick:button"])]))}const se={$style:W},_e=F(P,[["render",ae],["__cssModules",se]]);export{_e as default};
//# sourceMappingURL=SettingsLdapView-TOzVwbWB.js.map

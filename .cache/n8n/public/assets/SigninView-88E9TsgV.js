import{L as A,A as V}from"./AuthView-kdo3aJG-.js";import{e as T,db as I,f as R,dd as E,fH as v,_,d as L,u as B,l as N,V as D,fI as U}from"./n8n-_nNvRoCf.js";import{m as $}from"./pinia-aUqqC48i.js";import{G as F,ag as r,l as s,m as k,p as i,T as d,I as a,O as f,S as g,R as c,M as m,Q as n}from"./vendor-NNwioulI.js";import"./index-xP-VuMjv.js";import"./@n8n/codemirror-lang-sql-feLn5IS9.js";import"./@lezer/common-1hBQ1gIF.js";import"./codemirror-lang-html-n8n-wWQLhhqk.js";import"./prettier-s3fE3Qyr.js";import"./@jsplumb/util-DR0SB56A.js";import"./@jsplumb/core-MKwKlGip.js";import"./@jsplumb/common-Q5_tv_GT.js";import"./@jsplumb/connector-bezier-3dWY17R5.js";import"./lodash-es-5z_C16pm.js";import"./@jsplumb/browser-ui-AlqFM-P6.js";import"./uuid-McvpxQtQ.js";import"./luxon-ZRIU05qF.js";import"./esprima-next-ulPLCZ1Z.js";import"./@vueuse/core-8g26_cc0.js";import"./codemirror-lang-n8n-expression-HpIZnV_9.js";import"./fast-json-stable-stringify-eHEaCv8s.js";import"./timeago.js--Bumj2r9.js";import"./qrcode.vue-UdCmS1Sj.js";import"./vue3-touch-events-_RfbPMOD.js";import"./chart.js-JtqvIvkt.js";import"./axios-s2RMMPhA.js";import"./flatted-jPn12Tq4.js";import"./vue-i18n-1PEMRmUU.js";import"./@n8n/permissions-8yMqUF1Y.js";const u={MFA_TOKEN:"MFA_TOKEN",MFA_RECOVERY_CODE:"MFA_RECOVERY_CODE"},P=F({name:"MfaView",components:{Logo:A},props:{reportError:Boolean},setup(){return{...T()}},data(){return{hasAnyChanges:!1,formBus:I,formInputs:null,showRecoveryCodeForm:!1,verifyingMfaToken:!1,formError:""}},async mounted(){this.formInputs=[this.mfaTokenFieldWithDefaults()]},computed:{...$(R)},methods:{onRecoveryCodeClick(){this.formError="",this.showRecoveryCodeForm=!0,this.hasAnyChanges=!1,this.formInputs=[this.mfaRecoveryCodeFieldWithDefaults()],this.$emit("onFormChanged",u.MFA_RECOVERY_CODE)},onBackClick(){if(!this.showRecoveryCodeForm){this.$emit("onBackClick",u.MFA_TOKEN);return}this.showRecoveryCodeForm=!1,this.hasAnyChanges=!0,this.formInputs=[this.mfaTokenFieldWithDefaults()],this.$emit("onBackClick",u.MFA_RECOVERY_CODE)},onInput({target:{value:e,name:o}}){const l=o==="token"?E:v;if(e.length!==l){this.hasAnyChanges=!1;return}this.verifyingMfaToken=!0,this.hasAnyChanges=!0,this.onSubmit({token:e,recoveryCode:e}).catch(()=>{}).finally(()=>this.verifyingMfaToken=!1)},async onSubmit(e){this.formError=this.showRecoveryCodeForm?this.$locale.baseText("mfa.recovery.invalid"):this.$locale.baseText("mfa.code.invalid"),this.$emit("submit",e)},onSaveClick(){this.formBus.emit("submit")},mfaTokenFieldWithDefaults(){return this.formField("token",this.$locale.baseText("mfa.code.input.label"),this.$locale.baseText("mfa.code.input.placeholder"),E)},mfaRecoveryCodeFieldWithDefaults(){return this.formField("recoveryCode",this.$locale.baseText("mfa.recovery.input.label"),this.$locale.baseText("mfa.recovery.input.placeholder"),v)},formField(e,o,t,l,h=!0){return{name:e,initialValue:"",properties:{label:o,placeholder:t,maxlength:l,capitalize:!0,validateOnBlur:!1,focusInitially:h}}}}}),W="_container_1995o_9",z="_logoContainer_1995o_20",H="_formContainer_1995o_25",G="_headerContainer_1995o_29",q="_formError_1995o_34",Y="_recoveryCodeLink_1995o_38",K="_infoBox_1995o_42",Q={container:W,logoContainer:z,formContainer:H,headerContainer:G,formError:q,recoveryCodeLink:Y,infoBox:K};function X(e,o,t,l,h,M){const p=r("Logo"),C=r("n8n-heading"),S=r("n8n-form-inputs"),b=r("n8n-text"),w=r("n8n-button"),O=r("n8n-card");return s(),k("div",{class:a(e.$style.container)},[i("div",{class:a(e.$style.logoContainer)},[d(p)],2),d(O,null,{default:f(()=>[i("div",{class:a(e.$style.headerContainer)},[d(C,{size:"xlarge",color:"text-dark"},{default:f(()=>[g(c(e.showRecoveryCodeForm?e.$locale.baseText("mfa.recovery.modal.title"):e.$locale.baseText("mfa.code.modal.title")),1)]),_:1})],2),i("div",{class:a([e.$style.formContainer,e.reportError?e.$style.formError:""])},[e.formInputs?(s(),m(S,{key:0,"data-test-id":"mfa-login-form",inputs:e.formInputs,"event-bus":e.formBus,onInput:e.onInput,onSubmit:e.onSubmit},null,8,["inputs","event-bus","onInput","onSubmit"])):n("",!0),i("div",{class:a(e.$style.infoBox)},[!e.showRecoveryCodeForm&&!e.reportError?(s(),m(b,{key:0,size:"small",color:"text-base",bold:!1},{default:f(()=>[g(c(e.$locale.baseText("mfa.code.input.info"))+" ",1),i("a",{"data-test-id":"mfa-enter-recovery-code-button",onClick:o[0]||(o[0]=(...y)=>e.onRecoveryCodeClick&&e.onRecoveryCodeClick(...y))},c(e.$locale.baseText("mfa.code.input.info.action")),1)]),_:1})):n("",!0),e.reportError?(s(),m(b,{key:1,color:"danger",size:"small"},{default:f(()=>[g(c(e.formError)+" ",1),e.showRecoveryCodeForm?n("",!0):(s(),k("a",{key:0,class:a(e.$style.recoveryCodeLink),onClick:o[1]||(o[1]=(...y)=>e.onRecoveryCodeClick&&e.onRecoveryCodeClick(...y))},c(e.$locale.baseText("mfa.recovery.input.info.action")),3))]),_:1})):n("",!0)],2)],2),i("div",null,[d(w,{float:"right",loading:e.verifyingMfaToken,label:e.showRecoveryCodeForm?e.$locale.baseText("mfa.recovery.button.verify"):e.$locale.baseText("mfa.code.button.continue"),size:"large",disabled:!e.hasAnyChanges,onClick:e.onSaveClick},null,8,["loading","label","disabled","onClick"]),d(w,{float:"left",label:e.$locale.baseText("mfa.button.back"),size:"large",type:"tertiary",onClick:e.onBackClick},null,8,["label","onClick"])])]),_:1})],2)}const j={$style:Q},J=_(P,[["render",X],["__cssModules",j]]),Z=F({name:"SigninView",components:{AuthView:V,MfaView:J},setup(){return{...T()}},data(){return{FORM_CONFIG:{},loading:!1,showMfaView:!1,email:"",password:"",reportError:!1}},computed:{...$(R,N,B,L),userHasMfaEnabled(){var e;return!!((e=this.usersStore.currentUser)!=null&&e.mfaEnabled)}},mounted(){let e=this.$locale.baseText("auth.email");const o=this.settingsStore.ldapLoginLabel,t=this.settingsStore.isLdapLoginEnabled;t&&o&&(e=o),this.FORM_CONFIG={title:this.$locale.baseText("auth.signin"),buttonText:this.$locale.baseText("auth.signin"),redirectText:this.$locale.baseText("forgotPassword"),inputs:[{name:"email",properties:{label:e,type:"email",required:!0,...!t&&{validationRules:[{name:"VALID_EMAIL"}]},showRequiredAsterisk:!1,validateOnBlur:!1,autocomplete:"email",capitalize:!0}},{name:"password",properties:{label:this.$locale.baseText("auth.password"),type:"password",required:!0,showRequiredAsterisk:!1,validateOnBlur:!1,autocomplete:"current-password",capitalize:!0}}]},this.settingsStore.isDesktopDeployment||(this.FORM_CONFIG.redirectLink="/forgot-password")},methods:{async onMFASubmitted(e){await this.login({email:this.email,password:this.password,token:e.token,recoveryCode:e.recoveryCode})},async onEmailPasswordSubmitted(e){await this.login(e)},isRedirectSafe(){const e=this.getRedirectQueryParameter();return e.startsWith("/")||e.startsWith(window.location.origin)},getRedirectQueryParameter(){var o,t;let e="";return typeof((o=this.$route.query)==null?void 0:o.redirect)=="string"&&(e=decodeURIComponent((t=this.$route.query)==null?void 0:t.redirect)),e},async login(e){try{if(this.loading=!0,await this.usersStore.loginWithCreds({email:e.email,password:e.password,mfaToken:e.token,mfaRecoveryCode:e.recoveryCode}),this.loading=!1,this.settingsStore.isCloudDeployment)try{await this.cloudPlanStore.checkForCloudPlanData()}catch(o){console.warn("Failed to check for cloud plan data",o)}if(await this.settingsStore.getSettings(),this.clearAllStickyNotifications(),this.checkRecoveryCodesLeft(),this.$telemetry.track("User attempted to login",{result:this.showMfaView?"mfa_success":"success"}),this.isRedirectSafe()){const o=this.getRedirectQueryParameter();if(o.startsWith("http")){window.location.href=o;return}this.$router.push(o);return}await this.$router.push({name:D.HOMEPAGE})}catch(o){if(o.errorCode===U){this.showMfaView=!0,this.cacheCredentials(e);return}if(this.$telemetry.track("User attempted to login",{result:this.showMfaView?"mfa_token_rejected":"credentials_error"}),!this.showMfaView){this.showError(o,this.$locale.baseText("auth.signin.error")),this.loading=!1;return}this.reportError=!0}},onBackClick(e){this.reportError=!1,e===u.MFA_TOKEN&&(this.showMfaView=!1,this.loading=!1)},onFormChanged(e){e===u.MFA_RECOVERY_CODE&&(this.reportError=!1)},cacheCredentials(e){this.email=e.email,this.password=e.password},checkRecoveryCodesLeft(){if(this.usersStore.currentUser){const{hasRecoveryCodesLeft:e,mfaEnabled:o}=this.usersStore.currentUser;o&&!e&&this.showToast({title:this.$locale.baseText("settings.mfa.toast.noRecoveryCodeLeft.title"),message:this.$locale.baseText("settings.mfa.toast.noRecoveryCodeLeft.message"),type:"info",duration:0,dangerouslyUseHTMLString:!0})}}}});function x(e,o,t,l,h,M){const p=r("AuthView"),C=r("MfaView");return s(),k("div",null,[e.showMfaView?n("",!0):(s(),m(p,{key:0,form:e.FORM_CONFIG,"form-loading":e.loading,"with-sso":!0,"data-test-id":"signin-form",onSubmit:e.onEmailPasswordSubmitted},null,8,["form","form-loading","onSubmit"])),e.showMfaView?(s(),m(C,{key:1,"report-error":e.reportError,onSubmit:e.onMFASubmitted,onOnBackClick:e.onBackClick,onOnFormChanged:e.onFormChanged},null,8,["report-error","onSubmit","onOnBackClick","onOnFormChanged"])):n("",!0)])}const Me=_(Z,[["render",x]]);export{Me as default};
//# sourceMappingURL=SigninView-88E9TsgV.js.map

import{d as C}from"./pinia-aUqqC48i.js";import{S as E,m as R,l as $,e8 as T,v as b}from"./n8n-_nNvRoCf.js";import{e as g,r as n}from"./vendor-NNwioulI.js";const A=C(E.PUSH,()=>{const r=R(),v=$(),a=g(()=>r.sessionId),e=n(null),u=n(null),c=n(0),d=n(!1),t=n([]),l=n(!1),f=n([]),L=o=>(f.value.push(o),()=>{const s=f.value.indexOf(o);s!==-1&&f.value.splice(s,1)});function p(){w(),c.value++,u.value=setTimeout(O,Math.min(c.value*2e3,8*T.SECOND))}function w(){e.value!==null&&(e.value.removeEventListener("error",p),e.value.removeEventListener("close",p),e.value.removeEventListener("message",k),e.value.readyState<2&&e.value.close(),e.value=null),l.value=!1}function S(){w(),u.value&&(clearTimeout(u.value),u.value=null);const o=v.pushBackend==="websocket",{getRestUrl:s}=r,i=`/push?sessionId=${a.value}`;if(o){const{protocol:y,host:I}=window.location,U=s.startsWith("http")?s.replace(/^http/,"ws"):`${y==="https:"?"wss":"ws"}://${I+s}`;e.value=new WebSocket(`${U}${i}`)}else e.value=new EventSource(`${s}${i}`,{withCredentials:!0});e.value.addEventListener("open",m,!1),e.value.addEventListener("message",k,!1),e.value.addEventListener(o?"close":"error",p,!1)}function O(){S()}function h(o){e.value&&"send"in e.value&&e.value.send(JSON.stringify(o))}function m(){var o;if(l.value=!0,c.value=0,d.value=!1,r.pushConnectionActive=!0,(o=e.value)==null||o.removeEventListener("open",m),t.value.length){for(const s of t.value)h(s);t.value=[]}}function W(o){if(!l.value){t.value.push(o);return}h(o)}async function k(o){let s;try{s=JSON.parse(o.data)}catch{return}f.value.forEach(i=>i(s))}return{sessionId:a,pushSource:e,isConnectionOpen:l,addEventListener:L,pushConnect:S,pushDisconnect:w,send:W}}),D=C(E.COLLABORATION,()=>{const r=A(),v=b(),a=n({});r.addEventListener(t=>{if(t.type==="activeWorkflowUsersChanged"){const l=v.workflowId;t.data.workflowId===l&&(a.value[l]=t.data.activeUsers)}});const e=t=>{a.value=t},u=t=>{r.send({type:"workflowOpened",workflowId:t})},c=t=>{r.send({type:"workflowClosed",workflowId:t})},d=g(()=>a.value[v.workflowId]);return{usersForWorkflows:a,notifyWorkflowOpened:u,notifyWorkflowClosed:c,workflowUsersUpdated:e,getUsersForCurrentWorkflow:d}});export{A as a,D as u};
//# sourceMappingURL=collaboration.store-emJMSzVB.js.map
